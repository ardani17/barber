generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(cuid())
  username            String         @unique
  email               String         @unique
  password            String
  role                Role           @default(CASHIER)
  failedLoginAttempts Int            @default(0)
  lockedUntil         DateTime?
  lastFailedLogin     DateTime?
  transactions        Transaction[]

  @@index([username])
  @@index([email])
}

enum Role {
  OWNER
  CASHIER
}

model Barber {
  id                String             @id @default(cuid())
  name              String
  isActive          Boolean            @default(true)
  commissionRate    Decimal             @db.Decimal(10, 2)
  baseSalary        Decimal?            @db.Decimal(10, 2)
  compensationType  CompensationType    @default(COMMISSION_ONLY)
  password          String
  transactions      Transaction[]
  attendances       Attendance[]
  salaryPayments    SalaryPayment[]
  salaryDebts       SalaryDebt[]
  salaryAdjustments SalaryAdjustment[]
  salaryPeriods     SalaryPeriod[]

  @@index([isActive])
}

model Attendance {
  id        String       @id @default(cuid())
  barberId  String
  barber    Barber       @relation(fields: [barberId], references: [id])
  type      AttendanceType
  timestamp DateTime     @default(now())

  @@index([barberId])
  @@index([timestamp])
}

enum AttendanceType {
  CHECK_IN
  CHECK_OUT
  PERMISSION
  SICK
}

enum CompensationType {
  BASE_ONLY
  COMMISSION_ONLY
  BOTH
}

model Service {
  id                String              @id @default(cuid())
  name              String
  price             Decimal             @db.Decimal(10, 2)
  isActive          Boolean             @default(true)
  transactionItems  TransactionItem[]
}

model Product {
  id                String              @id @default(cuid())
  name              String
  buyPrice          Decimal             @db.Decimal(10, 2)
  sellPrice         Decimal             @db.Decimal(10, 2)
  stock             Int                 @default(0)
  isActive          Boolean             @default(true)
  transactionItems  TransactionItem[]

  @@index([stock])
}

model Transaction {
  id                String              @id @default(cuid())
  transactionNumber Int
  date              DateTime            @default(now())
  totalAmount       Decimal             @db.Decimal(10, 2)
  totalCommission   Decimal             @db.Decimal(10, 2)
  paymentMethod     PaymentMethod
  cashierId         String
  cashier           User                @relation(fields: [cashierId], references: [id])
  barberId          String
  barber            Barber              @relation(fields: [barberId], references: [id])
  items             TransactionItem[]

  @@unique([transactionNumber, date])
  @@index([date])
  @@index([barberId])
  @@index([cashierId])
}

enum PaymentMethod {
  TUNAI
  QRIS
}

model TransactionItem {
  id             String      @id @default(cuid())
  type           TransactionItemType
  quantity       Int
  unitPrice      Decimal     @db.Decimal(10, 2)
  subtotal       Decimal     @db.Decimal(10, 2)
  transactionId  String
  transaction    Transaction @relation(fields: [transactionId], references: [id])
  serviceId      String?
  service        Service?    @relation(fields: [serviceId], references: [id])
  productId      String?
  product        Product?    @relation(fields: [productId], references: [id])

  @@index([transactionId])
}

enum TransactionItemType {
  SERVICE
  PRODUCT
}

model Expense {
  id        String           @id @default(cuid())
  title     String
  amount    Decimal          @db.Decimal(10, 2)
  date      DateTime
  category  ExpenseCategory
  accountId String?
  account   CashAccount?     @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([date])
  @@index([accountId])
}

model CashAccount {
  id             String              @id @default(cuid())
  name           String
  type           AccountType
  balance        Decimal             @db.Decimal(15, 2) @default(0)
  accountNumber  String?
  isActive       Boolean             @default(true)
  isDefault      Boolean             @default(false)
  transactions   CashTransaction[]
  fromTransfers  CashTransaction[]   @relation("FromAccount")
  toTransfers    CashTransaction[]   @relation("ToAccount")
  expenses       Expense[]
  salaryPaymentsCash SalaryPayment[] @relation("SalaryCashAccount")
  salaryPaymentsBank SalaryPayment[] @relation("SalaryBankAccount")
  salaryPaymentsQris SalaryPayment[] @relation("SalaryQrisAccount")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([isActive])
  @@index([type])
}

model CashTransaction {
  id            String              @id @default(cuid())
  accountId     String?
  account       CashAccount?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  fromAccountId String?
  fromAccount   CashAccount?        @relation("FromAccount", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccountId   String?
  toAccount     CashAccount?        @relation("ToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)
  type          TransactionType
  amount        Decimal             @db.Decimal(10, 2)
  description   String
  date          DateTime            @default(now())

  @@index([accountId])
  @@index([date])
  @@index([type])
}

model CashRegister {
  id        String           @id @default(cuid())
  balance   Decimal          @db.Decimal(15, 2) @default(0)
  updatedAt DateTime         @updatedAt
}

model BankAccount {
  id        String           @id @default(cuid())
  name      String
  balance   Decimal          @db.Decimal(15, 2) @default(0)
  updatedAt DateTime         @updatedAt
}

model CashRegisterTransaction {
  id          String              @id @default(cuid())
  type        CashTransactionType
  amount      Decimal             @db.Decimal(10, 2)
  description String
  date        DateTime            @default(now())
  transactionId String?

  @@index([date])
  @@index([transactionId])
}

model BankTransaction {
  id          String            @id @default(cuid())
  type        BankTransactionType
  amount      Decimal           @db.Decimal(10, 2)
  description String
  date        DateTime          @default(now())
  transactionId String?

  @@index([date])
  @@index([transactionId])
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SUPPLIES
  OTHER
}

enum CashTransactionType {
  IN
  OUT
}

enum BankTransactionType {
  IN
  OUT
}

enum AccountType {
  TUNAI
  BANK
  QRIS
}

enum TransactionType {
  DEPOSIT
  WITHDRAW
  TRANSFER
}

model SalaryPayment {
  id                String              @id @default(cuid())
  barberId          String
  barber            Barber              @relation(fields: [barberId], references: [id])
  periodStart       DateTime
  periodEnd         DateTime
  baseSalaryAmount  Decimal             @db.Decimal(10, 2)
  commissionAmount  Decimal             @db.Decimal(10, 2)
  bonusAmount       Decimal             @db.Decimal(10, 2) @default(0)
  deductionAmount   Decimal             @db.Decimal(10, 2) @default(0)
  totalAmount       Decimal             @db.Decimal(10, 2)
  cashAmount        Decimal             @db.Decimal(10, 2)
  bankAmount        Decimal             @db.Decimal(10, 2)
  qrisAmount        Decimal             @db.Decimal(10, 2)
  cashAccountId     String?
  cashAccount       CashAccount?        @relation("SalaryCashAccount", fields: [cashAccountId], references: [id])
  bankAccountId     String?
  bankAccount       CashAccount?        @relation("SalaryBankAccount", fields: [bankAccountId], references: [id])
  qrisAccountId     String?
  qrisAccount       CashAccount?        @relation("SalaryQrisAccount", fields: [qrisAccountId], references: [id])
  paymentDate       DateTime            @default(now())
  notes             String?
  createdAt         DateTime            @default(now())

  @@index([barberId])
  @@index([paymentDate])
  @@index([periodStart, periodEnd])
}

model SalaryDebt {
  id                String              @id @default(cuid())
  barberId          String
  barber            Barber              @relation(fields: [barberId], references: [id])
  amount            Decimal             @db.Decimal(10, 2)
  reason            String
  isPaid            Boolean             @default(false)
  paidDate          DateTime?
  paymentId         String?
  createdAt         DateTime            @default(now())
  paidAt            DateTime?

  @@index([barberId])
  @@index([isPaid])
}

model SalaryAdjustment {
  id                String              @id @default(cuid())
  barberId          String
  barber            Barber              @relation(fields: [barberId], references: [id])
  periodStart       DateTime
  periodEnd         DateTime
  type              AdjustmentType
  amount            Decimal             @db.Decimal(10, 2)
  reason            String
  createdAt         DateTime            @default(now())

  @@index([barberId])
  @@index([periodStart, periodEnd])
  @@index([type])
}

enum AdjustmentType {
  BONUS
  DEDUCTION
}

model SalaryPeriod {
  id                String              @id @default(cuid())
  barberId          String
  barber            Barber              @relation(fields: [barberId], references: [id], onDelete: Cascade)
  name              String
  startDate         DateTime
  endDate           DateTime
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([barberId, isActive])
  @@index([barberId])
  @@index([isActive])
}
